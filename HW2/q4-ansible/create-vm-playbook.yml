---
- name: Ansible test
  hosts: [localhost]
  user: root
  vars_files:
    - vars/config.yml
    
  tasks:
    - name: install packages
      apt:
        name: "{{ packages }}"
        state: present

  # Create a bridge named br-int
    - name: Create an OVS bridge
      openvswitch_bridge:
        bridge: "{{ ovs_network.br_name }}"
        state: present
    - name: Define OVS network
      virt_net:
        command: define
        name: {{ ovs_network.name }}
        xml: '{{ lookup("template", "network/bridge.xml.j2") }}'
    - name: Create OVS network
      virt_net:
        command: create
        name: "{{ ovs_network.name }}"
      become: yes
      ignore_errors: true

    - name: Convert bridge to an L3 network
      command: "ifconfig {{ ovs_network.br_name }} 10.10.0.1/24"
      ignore_errors: true
      become: yes 


    - name: Install VM1
      become: yes
      command: virt-clone --original sampleVM -n yjkamdarVM1 --auto-clone
      ignore_errors: yes

    - name: Install VM2
      become: yes
      command: virt-clone --original yjkamdarVM1 -n yjkamdarVM2 --auto-clone
      ignore_errors: yes

    - name: Start VM1
      virt:
        name: yjkamdarVM1
        command: start
        state: running

    - name: Start VM2
      virt:
        name: yjkamdarVM2
        command: start
        state: running

    - virt_net:
      command: list_nets

      #sudo virt-clone --original VM2 -n VM3 --auto-clone
      # - name: Create VM2 from VM1
      #become: yes
      #command: sudo virt-clone --original yjkamdarVM1 -n yjkamdarVM2 --auto-clone 
